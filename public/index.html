<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FB Reel Downloader 2025</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white shadow-xl rounded-lg p-6 w-full max-w-md">
        <h1 class="text-2xl font-bold text-blue-600 mb-2 text-center">Facebook Downloader</h1>
        <p class="text-xs text-center text-gray-400 mb-6">Hỗ trợ Video & Audio (Giả lập) tốt nhất 2025</p>
        
        <div class="mb-4">
            <label class="block text-gray-700 text-sm font-bold mb-2">Dán Link Video/Reel:</label>
            <input type="text" id="videoLink" placeholder="Ví dụ: https://www.facebook.com/reel/..." class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
        </div>

        <div class="mb-6">
            <label class="block text-gray-700 text-sm font-bold mb-2">Chọn định dạng:</label>
            <div class="flex gap-2">
                <button id="optVideo" onclick="selectType('video')" class="flex-1 py-2 px-4 rounded border border-blue-500 bg-blue-500 text-white font-bold transition">
                    VIDEO (MP4)
                </button>
                <button id="optAudio" onclick="selectType('audio')" class="flex-1 py-2 px-4 rounded border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition">
                    AUDIO (M4A)
                </button>
            </div>
        </div>

        <button onclick="processDownload()" id="btnDownload" class="w-full bg-gray-800 hover:bg-gray-900 text-white font-bold py-3 rounded-lg transition duration-300 flex justify-center items-center gap-2 shadow-lg">
            <span>BẮT ĐẦU TẢI</span>
        </button>

        <div class="mt-6">
            <div id="logArea" class="bg-black text-green-400 text-xs p-3 rounded h-32 overflow-y-auto font-mono border border-gray-700">
                <p class="opacity-50">> System ready...</p>
            </div>
        </div>
    </div>

    <script>
        let selectedType = 'video';
        const logArea = document.getElementById('logArea');
        const btn = document.getElementById('btnDownload');

        function selectType(type) {
            selectedType = type;
            document.getElementById('optVideo').className = type === 'video' ? 'flex-1 py-2 px-4 rounded border border-blue-500 bg-blue-500 text-white font-bold transition' : 'flex-1 py-2 px-4 rounded border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition';
            document.getElementById('optAudio').className = type === 'audio' ? 'flex-1 py-2 px-4 rounded border border-purple-500 bg-purple-500 text-white font-bold transition' : 'flex-1 py-2 px-4 rounded border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 transition';
            addLog(`> Đã chọn chế độ: ${type.toUpperCase()}`);
        }

        function addLog(msg, color = 'text-green-400') {
            const p = document.createElement('p');
            p.innerText = msg;
            p.className = color + ' mb-1';
            logArea.appendChild(p);
            logArea.scrollTop = logArea.scrollHeight;
        }

        async function processDownload() {
            const url = document.getElementById('videoLink').value.trim();
            if (!url) return addLog("> Lỗi: Vui lòng nhập link!", 'text-red-400');

            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div> Đang xử lý...';
            addLog("> Đang kết nối server Netlify...");

            try {
                // Bước 1: Lấy Link Gốc
                const res = await fetch('/api/fb-downloader', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                if (!res.ok) throw new Error((await res.json()).error);
                
                const data = await res.json();
                const finalLink = data.downloadUrl;
                addLog("> Đã lấy được link gốc từ Facebook!");

                // Bước 2: Gọi Proxy để ép tải về
                addLog(`> Đang tải xuống dưới dạng ${selectedType.toUpperCase()}...`);
                addLog("> (Nếu file lớn > 5MB, sẽ mở tab mới)");

                // Tạo link Proxy qua server của mình
                const proxyUrl = `/api/fb-downloader?url=${encodeURIComponent(finalLink)}&type=${selectedType}`;
                
                // Kích hoạt tải
                window.location.href = proxyUrl;

                setTimeout(() => {
                    addLog("> Hoàn tất yêu cầu.", 'text-blue-400');
                    btn.disabled = false;
                    btn.innerText = 'BẮT ĐẦU TẢI LẠI';
                }, 2000);

            } catch (error) {
                addLog(`> Lỗi: ${error.message}`, 'text-red-500');
                btn.disabled = false;
                btn.innerText = 'THỬ LẠI';
            }
        }
    </script>
</body>
</html>
